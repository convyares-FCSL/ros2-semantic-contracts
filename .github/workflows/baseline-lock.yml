name: Baseline Lock (Docker Harness)

on:
  pull_request:
    branches:
      - dev
  push:
    branches:
      - dev

jobs:
  baseline-lock:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Clean evidence directory
        run: rm -rf evidence/
      
      - name: Run docker harness (H00 baseline)
        run: docker compose up --build --abort-on-container-exit
      
      - name: Check evidence files exist
        run: |
          test -s evidence/trace.jsonl || { echo "ERROR: trace.jsonl missing or empty"; exit 1; }
          test -s evidence/report.json || { echo "ERROR: report.json missing or empty"; exit 1; }
      
      - name: Sanity Check - Validate report.json
        run: |
          jq empty evidence/report.json || { echo "ERROR: report.json is not valid JSON"; exit 1; }
      
      - name: Sanity Check - Validate trace.jsonl
        run: |
          python3 -c "
          import json
          import sys
          with open('evidence/trace.jsonl', 'r') as f:
              for line_num, line in enumerate(f, 1):
                  line = line.strip()
                  if not line:
                      continue
                  try:
                      json.loads(line)
                  except json.JSONDecodeError as e:
                      print(f'ERROR: Invalid JSON at line {line_num}: {e}')
                      sys.exit(1)
          print('trace.jsonl: all lines valid')
          " || exit 1
      
      - name: Upload evidence artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evidence-baseline-lock
          path: evidence/
          retention-days: 7
